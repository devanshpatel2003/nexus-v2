# ============================================================
# NEXUS v2 — CI/CD Pipeline
# Runs on every push and PR to main.
# Jobs: lint → test → build (Docker deployability check)
# ============================================================

name: NEXUS v2 CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:

  # ────────────────────────────
  # 1. LINT — syntax + import checks
  # ────────────────────────────
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      - name: Flake8 — critical errors only
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=.git,__pycache__,venv,.venv,driver-plan,indexes

      - name: Compile all Python files (syntax check)
        run: |
          python -m py_compile app.py
          find core/ tools/ data/ tests/ -name "*.py" -exec python -m py_compile {} +

  # ────────────────────────────
  # 2. TEST — pytest across Python versions
  # ────────────────────────────
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v \
            --tb=short \
            --co -q 2>/dev/null || true
          pytest tests/test_rag.py tests/test_grounding.py -v --tb=short
          pytest tests/test_tools.py::TestToolSchemas -v --tb=short

      - name: Run data module import checks
        run: |
          python -c "from data.export_control_events import get_events_dataframe; df = get_events_dataframe(); assert len(df) > 0; print(f'Events loaded: {len(df)}')"
          python -c "from data.universe import UNIVERSE; assert len(UNIVERSE) > 0; print(f'Universe: {len(UNIVERSE)} tickers')"
          python -c "from core.llm.prompts import SYSTEM_PROMPT; assert len(SYSTEM_PROMPT) > 100; print('System prompt OK')"
          python -c "from core.config import LLM_MODEL, EMBEDDING_MODEL; print(f'Models: {LLM_MODEL}, {EMBEDDING_MODEL}')"

  # ────────────────────────────
  # 3. BUILD — Docker deployability check
  # ────────────────────────────
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t nexus-v2:${{ github.sha }} .

      - name: Verify container starts
        run: |
          docker run -d --name nexus-smoke \
            -e OPENAI_API_KEY=sk-test-dummy-key-for-ci \
            -p 8501:8501 \
            nexus-v2:${{ github.sha }}
          sleep 8
          curl -sf http://localhost:8501/_stcore/health || (docker logs nexus-smoke && exit 1)
          docker stop nexus-smoke
          echo "Container health check passed"
